GameSpace 遊戲論壇平台精簡規格（去除敘事流程版）
【最後更新日期：2025-10-27】

【系統總覽】
- 定位：遊戲討論＋社群互動平台（會員、追蹤、社群、交易）。
- 架構：MVC＋三層式（Presentation/Business/Data），Controller→Service→Repository，DTO跨層傳遞。
- 資料庫：SQL Server；主鍵/唯一/複合索引與外鍵完整；欄位具中文註解。
- 主要模組：註冊/認證、錢包點數、每日簽到、寵物養成、小遊戲、官方商城、C2C 市場、優惠券/禮券、熱度與排行榜、論壇、好友/群組、即時聊天、通知、收藏/按讚、管理後台與權限。
- 排除範圍：實體物流配送、行動 App、多語系（僅 zh-Hant）、內嵌可交互遊戲（僅追蹤外部數據）。

【術語與規則】
- 錢包與券：E‑voucher（電子禮券，點數兌換，用於折抵/兌換）、Coupon（商城折扣券）、Point（平台虛擬貨幣）。
- 簽到：每日一次、連續簽到（形成紀錄）、獎勵含點數/寵物經驗/優惠券。
- 寵物：史萊姆；五維屬性（飢餓、心情、體力、清潔、健康）；經驗值與等級獎勵。
- 小遊戲：冒險挑戰；每日最多 3 次。

【技術架構與工具】
- 後端：ASP.NET MVC + C#；EF Core(ORM)＋Repository；表現層（控制器/Razor）、業務層（服務/控制器）、資料層（Repository/EF）。
- 前端：Razor + HTML/CSS/JS；UI 採 Bootstrap；可視需要整合 Vue.js/Tailwind。
- 開發/測試/部署：VS2022/VS Code、Git(GitHub)、SSMS；Postman/Swagger；xUnit/MSTest、TestHost、Selenium；Docker；GitHub Actions/Azure DevOps；Application Insights；Serilog/NLog。
- 認證授權：Email/密碼＋OAuth（Google/Facebook/Discord）；JWT 或 Session；RBAC 權限。

【資料庫原則】
- 型別：int、nvarchar、datetime2、bit、decimal、varbinary(max) 等。
- 鍵索引：主鍵多為自增 INT；必要唯一/複合索引優化查詢；完整外鍵關聯。
- 稽核：過期/已用紀錄保留；避免物理刪除（必要時邏輯標記）。

【優惠券（Coupon）- 實際資料庫結構】
- CouponType（券類型定義）：
  - 主鍵：CouponTypeID (int IDENTITY)
  - 欄位：Name (nvarchar(50), UNIQUE)、DiscountType (nvarchar(20), 'PERCENT'或'AMOUNT')、DiscountValue (decimal(18,2))、MinSpend (decimal(18,2))、ValidFrom (datetime2(7))、ValidTo (datetime2(7))、PointsCost (int)、Description (nvarchar(600))
  - 軟刪除：IsDeleted、DeletedAt、DeletedBy、DeleteReason
  - CHECK 約束：ValidFrom <= ValidTo
- Coupon（優惠券實例）：
  - 主鍵：CouponID (int IDENTITY)
  - 外鍵：CouponTypeID → CouponType、UserID → Users.User_ID
  - 欄位：CouponCode (nvarchar(50), UNIQUE)、IsUsed (bit, 預設0)、AcquiredTime (datetime2(7))、UsedTime (datetime2(7), 可空)、UsedInOrderID (int, 可空)
  - 軟刪除：IsDeleted、DeletedAt、DeletedBy、DeleteReason
  - CHECK 約束：IsUsed=0 時 UsedTime 和 UsedInOrderID 必須為 NULL；IsUsed=1 時兩者不可為 NULL
  - 索引：IX_Coupon_user_used (UserID, IsUsed, AcquiredTime)

【電子禮券（EVoucher）與核銷 - 實際資料庫結構】
- EVoucherType（禮券類型定義）：
  - 主鍵：EVoucherTypeID (int IDENTITY)
  - 欄位：Name (nvarchar(50))、ValueAmount (decimal(18,2))、ValidFrom (datetime2(7))、ValidTo (datetime2(7))、PointsCost (int)、TotalAvailable (int)、Description (nvarchar(600))
  - 軟刪除：IsDeleted、DeletedAt、DeletedBy、DeleteReason
- EVoucher（電子禮券實例）：
  - 主鍵：EVoucherID (int IDENTITY)
  - 外鍵：EVoucherTypeID → EVoucherType、UserID → Users.User_ID
  - 欄位：EVoucherCode (nvarchar(50), UNIQUE)、IsUsed (bit, 預設0)、AcquiredTime (datetime2(7))、UsedTime (datetime2(7), 可空)
  - 軟刪除：IsDeleted、DeletedAt、DeletedBy、DeleteReason
  - 索引：IX_EVoucher_user_used (UserID, IsUsed, AcquiredTime)
- EVoucherToken（一次性核銷憑證）：
  - 主鍵：TokenID (int IDENTITY)
  - 外鍵：EVoucherID → EVoucher
  - 欄位：Token (varchar(64), 非空)、ExpiresAt (datetime2(7))、IsRevoked (bit, 預設0)
  - 軟刪除：IsDeleted、DeletedAt、DeletedBy、DeleteReason
- EVoucherRedeemLog（核銷記錄）：
  - 主鍵：RedeemID (int IDENTITY)
  - 外鍵：EVoucherID → EVoucher (CASCADE DELETE)、TokenID → EVoucherToken (可空)、UserID → Users.User_ID
  - 欄位：ScannedAt (datetime2(7))、Status (nvarchar(20), 可選值：'REVOKED'/'REJECTED'/'EXPIRED'/'ALREADYUSED'/'APPROVED')
  - 軟刪除：IsDeleted、DeletedAt、DeletedBy、DeleteReason
  - CHECK 約束：Status 必須為上述五個值之一

【兌換（以點數）】
- 條件：User_Point ≥ PointsCost。
- 事務步驟：(1) 扣點；(2) 新增對應 Coupon/EVoucher 指派用戶；(3) 記 WalletHistory（例：500點兌 85 折券）。

【使用規則（優惠券）】
- 驗證：屬於該用戶、在有效期、IsUsed=0、符合 MinSpend。
- 計算：Percent＝商品總額×DiscountValue；Amount＝固定額扣減（結果不得為負）。
- 訂單：更新 order_total；券設 IsUsed=1、填 UsedTime、關聯 UsedInOrderID。
- 取消：不自動返還；管理員可手動重置或補發。
- 疊加/精度：每訂單最多 1 張（是否允許滿額＋免運依營運規則）；折扣金額四捨五入至整數或 0.1 單位避免浮點誤差。

【使用規則（電子禮券）】
- 流程：掃描 EVoucherCode 或一次性 EVoucherToken→驗證（存在/未過期/未撤銷/未使用）。
- 成功：EVoucher 設 IsUsed=1、填 UsedTime、RedeemLog=Approved；失敗記錄相應狀態。
- 安全：Token 高強度隨機、短效（如 5 分鐘）、一次性；可撤銷（IsRevoked=1）。

【前端介面要點】
- 我的優惠券：分「可使用」「已使用/過期」；卡片顯示券碼、折扣、有效期、使用說明。
- 結帳頁：下拉或輸入券碼後送後端驗證；前端先做格式/點數餘額檢查。
- 禮券展示：按鈕請求生成 EVoucherToken 並顯示條碼/QR；顯示名稱、面額、有效期。

【資料分析與事件追蹤】
- 事件（含意）：user_registered、daily_checkin_completed、streak_checkin_bonus、pet_leveled_up、game_completed、points_earned、points_spent、coupon_received、evoucher_received、coupon_used、evoucher_redeemed、post_published、post_replied、friend_request_sent/accepted、user_blocked、system_maintenance。
- 指標：日新增、簽到率、7日留存、遊戲放棄率、券使用率、商城銷售等；異常用於營運調整與產品優化。
- 實作：EventTracker.Log(...)→寫 DB/訊息佇列；匿名化與隱私保護；後台每日彙總 KPI 圖表。

【管理後台（功能）】
- Dashboard 與報表：KPI 趨勢、時間範圍/分群切換、常見報表（用戶成長、DAU/MAU、貼文數、銷售額、熱門遊戲排行榜）。
- 內容治理：舉報審核、隱藏/下架、違規處置（停權/鎖定）。
- 商城作業：訂單處理（待出貨→已出貨；數位商品完成後寄序號）。
- 社群管理：聊天內容抽查、好友封鎖名單檢視。
- 系統公告：全站通知（標題/內容/對象）。
- 券與點數：券發放、點數調整、例外處理（取消訂單後人工返券/補發）。

【實際資料庫結構重點說明（2025-10-27更新）】
- User_Wallet 表：僅包含 User_Id (PK, FK)、User_Point (int)、軟刪除欄位（IsDeleted、DeletedAt、DeletedBy、DeleteReason）
  【已移除】Coupon_Number、EVoucher_Number 欄位（券類改由專用表 Coupon/EVoucher 管理）
- WalletHistory 表：完整欄位為 LogID、UserID、ChangeType (nvarchar(20))、PointsChanged (int)、ItemCode (nvarchar(50))、Description (nvarchar(255))、ChangeTime (datetime2(7))、軟刪除欄位
  索引：IX_WalletHistory_user_time (UserID, ChangeTime)、IX_WalletHistory_type_time (ChangeType, ChangeTime)
- SignInRule 表：新增表格，用於設定簽到規則
  欄位：Id (PK)、SignInDay (int, 1-365, UNIQUE)、Points (int)、Experience (int)、HasCoupon (bit)、CouponTypeCode (nvarchar(50))、IsActive (bit)、CreatedAt、UpdatedAt、Description、軟刪除欄位
  CHECK 約束：HasCoupon=1 時 CouponTypeCode 不可為 NULL；HasCoupon=0 時必須為 NULL
- Pet 表欄位更新：
  【欄位名稱變更】SkinColor (varchar(7), 格式#RRGGBB)、SkinColorChangedTime、BackgroundColor (nvarchar(20))、BackgroundColorChangedTime
  【欄位名稱變更】PointsChanged_SkinColor、PointsChanged_BackgroundColor（取代舊名 PointsChanged_color）
  【新增欄位】CurrentExperience (int)、ExperienceToNextLevel (int)、TotalPointsGained_LevelUp (int)
- 新增設定表：
  • PetSkinColorCostSettings：膚色價格設定（SettingId, ColorCode, ColorName, PointsCost, Rarity, IsFree, IsLimitedEdition等）
  • PetBackgroundCostSettings：背景價格設定（SettingId, BackgroundCode, BackgroundName, PointsCost等）
  • PetLevelRewardSettings：升級獎勵規則（SettingId, LevelRangeStart, LevelRangeEnd, PointsReward等）
  • SystemSettings：系統設定（SettingId, SettingKey (UNIQUE), SettingValue (nvarchar(MAX)), Category, SettingType等）
- Users 表新增欄位：User_EmailConfirmed、User_PhoneNumberConfirmed、User_TwoFactorEnabled、User_AccessFailedCount、User_LockoutEnabled、User_LockoutEnd
- ManagerData 表新增欄位：Manager_Email、Manager_EmailConfirmed、Manager_AccessFailedCount、Manager_LockoutEnabled、Manager_LockoutEnd
- 所有 MiniGame Area 主要表格均實作軟刪除：IsDeleted (bit)、DeletedAt (datetime2(7))、DeletedBy (int)、DeleteReason (nvarchar(500))

【未決與排除範圍】
- 文章評論：thread_posts＋target_type 區分即可，DB 無需調整。
- 購物車：採 Session 流程，未納入持久化（不影響關鍵交易）；未來若需再增表。
- 即時聊天：文字為主、允許 Emoji；無影音訊息存儲。
- 擴展方向：約玩配對、AI 推薦、動態牆等（尚未實作支援）。
